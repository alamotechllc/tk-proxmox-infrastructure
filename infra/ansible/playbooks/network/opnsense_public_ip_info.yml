---
# OPNsense Public IP Address Information
# Displays current public IP addresses and WAN interface details
# Useful for monitoring external connectivity and IP changes

- name: "OPNsense Public IP Address Information"
  hosts: localhost
  gather_facts: true
  serial: 1
  
  vars:
    opnsense_host: "{{ opnsense_host | default('172.23.5.1') }}"
    opnsense_api_key: "{{ opnsense_api_key | default('YOUR_OPNSENSE_API_KEY') }}"
    opnsense_api_secret: "{{ opnsense_api_secret | default('YOUR_OPNSENSE_API_SECRET') }}"
    opnsense_verify_ssl: "{{ opnsense_verify_ssl | default(false) }}"
  
  pre_tasks:
    - name: Validate OPNsense connectivity
      uri:
        url: "https://{{ opnsense_host }}/api/core/firmware/info"
        method: GET
        user: "{{ opnsense_api_key }}"
        password: "{{ opnsense_api_secret }}"
        force_basic_auth: yes
        validate_certs: "{{ opnsense_verify_ssl }}"
      register: opnsense_connectivity
      failed_when: false
    
    - name: Display connectivity status with beautiful formatting
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                       ğŸ”¥ OPNsense CONNECTIVITY TEST                          â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ Host: {{ opnsense_host }}
          â•‘ Status: {{ 'âœ… Connected' if opnsense_connectivity.status == 200 else 'âŒ Failed' }}
          â•‘ {% if opnsense_connectivity.status == 200 %}
          â•‘ Product: {{ opnsense_connectivity.json.product_id }}
          â•‘ Version: {{ opnsense_connectivity.json.product_version }}
          â•‘ {% else %}
          â•‘ Error: {{ opnsense_connectivity.msg }}
          â•‘ {% endif %}
          â•‘ Timestamp: {{ ansible_date_time.iso8601 }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  tasks:
    - name: Get interface information for WAN detection
      uri:
        url: "https://{{ opnsense_host }}/api/core/interfaces/search"
        method: POST
        user: "{{ opnsense_api_key }}"
        password: "{{ opnsense_api_secret }}"
        force_basic_auth: yes
        validate_certs: "{{ opnsense_verify_ssl }}"
        body_format: json
        body:
          current: 1
          rowCount: 100
          sort: {}
          searchPhrase: ""
      register: interface_list
      when: opnsense_connectivity.status == 200
    
    - name: Get current public IP via external service
      uri:
        url: "https://api.ipify.org"
        method: GET
        timeout: 10
      register: public_ip_result
      failed_when: false
      when: opnsense_connectivity.status == 200
    
    - name: Get detailed IP information
      uri:
        url: "https://ipapi.co/{{ public_ip_result.content | trim }}/json/"
        method: GET
        timeout: 10
      register: ip_details
      failed_when: false
      when: public_ip_result.status == 200 and public_ip_result.content is defined
    
    - name: Display WAN interface information with beautiful formatting
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                          ğŸŒ WAN INTERFACE INFORMATION                        â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ {% if interface_list.json is defined and interface_list.json.rows is defined %}
          â•‘ {% for interface in interface_list.json.rows %}
          â•‘ {% if 'wan' in interface.if | lower or 'pppoe' in interface.descr | lower %}
          â•‘ Interface: {{ interface.if }}
          â•‘ Description: {{ interface.descr | default('No description') }}
          â•‘ Status: {{ interface.status | default('Unknown') }}
          â•‘ IP Address: {{ interface.ipaddr | default('Not assigned') }}
          â•‘ Gateway: {{ interface.gateway | default('Not set') }}
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ {% endif %}
          â•‘ {% endfor %}
          â•‘ {% else %}
          â•‘ âŒ Failed to retrieve interface information
          â•‘ {% endif %}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when: opnsense_connectivity.status == 200
    
    - name: Display current public IP with beautiful formatting
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                           ğŸŒ CURRENT PUBLIC IP ADDRESS                       â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ {% if public_ip_result.status == 200 %}
          â•‘ Public IP: {{ public_ip_result.content | trim }}
          â•‘ Detection Method: External API (ipify.org)
          â•‘ Status: âœ… Successfully detected
          â•‘ {% else %}
          â•‘ Public IP: Unable to determine
          â•‘ Status: âŒ Failed to detect external IP
          â•‘ Error: {{ public_ip_result.msg | default('Unknown error') }}
          â•‘ {% endif %}
          â•‘ Timestamp: {{ ansible_date_time.iso8601 }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when: opnsense_connectivity.status == 200
    
    - name: Display detailed IP information with beautiful formatting
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                           ğŸ“ DETAILED IP INFORMATION                         â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ {% if ip_details.status == 200 and ip_details.json is defined %}
          â•‘ IP Address: {{ ip_details.json.ip }}
          â•‘ Country: {{ ip_details.json.country_name | default('Unknown') }}
          â•‘ Region: {{ ip_details.json.region | default('Unknown') }}
          â•‘ City: {{ ip_details.json.city | default('Unknown') }}
          â•‘ ISP: {{ ip_details.json.org | default('Unknown') }}
          â•‘ ASN: {{ ip_details.json.asn | default('Unknown') }}
          â•‘ Timezone: {{ ip_details.json.timezone | default('Unknown') }}
          â•‘ {% else %}
          â•‘ âŒ Failed to retrieve detailed IP information
          â•‘ {% if ip_details.status is defined %}
          â•‘ Error: {{ ip_details.msg | default('Unknown error') }}
          â•‘ {% endif %}
          â•‘ {% endif %}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      when: opnsense_connectivity.status == 200 and public_ip_result.status == 200

  post_tasks:
    - name: Display beautiful summary
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                    âœ… OPNsense PUBLIC IP INFORMATION COMPLETE                 â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ OPNsense Host: {{ opnsense_host }}
          â•‘ {% if public_ip_result.status == 200 %}
          â•‘ Current Public IP: {{ public_ip_result.content | trim }}
          â•‘ {% else %}
          â•‘ Public IP Status: âŒ Unable to determine
          â•‘ {% endif %}
          â•‘ Completion Time: {{ ansible_date_time.iso8601 }}
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘ ğŸ’¡ Next Steps:                                                              â•‘
          â•‘   ğŸŒ Monitor for IP changes if using dynamic ISP                            â•‘
          â•‘   ğŸ”§ Configure DDNS if needed for dynamic IP management                     â•‘
          â•‘   ğŸ“Š Use this information for firewall rules and VPN configuration          â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
