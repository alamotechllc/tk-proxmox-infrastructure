---
- name: "OPNsense Service Management"
  hosts: localhost
  gather_facts: true
  serial: 1
  
  vars:
    opnsense_host: "{{ opnsense_host | default('172.23.5.1') }}"
    opnsense_api_key: "{{ opnsense_api_key | default('YOUR_OPNSENSE_API_KEY') }}"
    opnsense_api_secret: "{{ opnsense_api_secret | default('YOUR_OPNSENSE_API_SECRET') }}"
    opnsense_verify_ssl: "{{ opnsense_verify_ssl | default(false) }}"
  
  pre_tasks:
    - name: Validate OPNsense connectivity
      uri:
        url: "https://{{ opnsense_host }}/api/core/firmware/info"
        method: GET
        user: "{{ opnsense_api_key }}"
        password: "{{ opnsense_api_secret }}"
        force_basic_auth: yes
        validate_certs: "{{ opnsense_verify_ssl }}"
      register: opnsense_connectivity
      failed_when: false
    
    - name: Display connectivity status with beautiful formatting
      debug:
        msg: |
          ╔═══════════════════════════════════════════════════════════════════════════════╗
          ║                       🔥 OPNsense CONNECTIVITY TEST                          ║
          ╠═══════════════════════════════════════════════════════════════════════════════╣
          ║ Host: {{ opnsense_host }}
          ║ Status: {{ '✅ Connected' if opnsense_connectivity.status == 200 else '❌ Failed' }}
          ║ {% if opnsense_connectivity.status == 200 %}
          ║ Product: {{ opnsense_connectivity.json.product_id }}
          ║ Version: {{ opnsense_connectivity.json.product_version }}
          ║ {% else %}
          ║ Error: {{ opnsense_connectivity.msg }}
          ║ {% endif %}
          ║ Timestamp: {{ ansible_date_time.iso8601 }}
          ╚═══════════════════════════════════════════════════════════════════════════════╝

  tasks:
    - name: Get service list
      uri:
        url: "https://{{ opnsense_host }}/api/core/service/search"
        method: POST
        user: "{{ opnsense_api_key }}"
        password: "{{ opnsense_api_secret }}"
        force_basic_auth: yes
        validate_certs: "{{ opnsense_verify_ssl }}"
        body_format: json
        body:
          current: 1
          rowCount: 100
          sort: {}
          searchPhrase: ""
      register: service_list
      when: (operation | default('list')) == 'list'
    
    - name: Display service list with beautiful formatting
      debug:
        msg: |
          ╔═══════════════════════════════════════════════════════════════════════════════╗
          ║                           🔥 OPNsense SERVICES LIST                           ║
          ╠═══════════════════════════════════════════════════════════════════════════════╣
          ║ {% if service_list.json is defined and service_list.json.rows is defined %}
          ║ {% for service in service_list.json.rows %}
          ║ Service: {{ service.name }}
          ║ Status: {{ service.status | default('Unknown') }}
          ║ Description: {{ service.description | default('No description') }}
          ╠═══════════════════════════════════════════════════════════════════════════════╣
          ║ {% endfor %}
          ║ {% else %}
          ║ ❌ Failed to retrieve service list
          ║ {% endif %}
          ╚═══════════════════════════════════════════════════════════════════════════════╝
      when: (operation | default('list')) == 'list'
    
    - name: Start service
      uri:
        url: "https://{{ opnsense_host }}/api/core/service/start"
        method: POST
        user: "{{ opnsense_api_key }}"
        password: "{{ opnsense_api_secret }}"
        force_basic_auth: yes
        validate_certs: "{{ opnsense_verify_ssl }}"
        body_format: json
        body:
          service: "{{ service_name | default('') }}"
      register: start_result
      when: (operation | default('list')) == 'start' and (service_name | default('')) != ''
    
    - name: Display start result with beautiful formatting
      debug:
        msg: |
          ╔═══════════════════════════════════════════════════════════════════════════════╗
          ║                          🚀 SERVICE START RESULT                             ║
          ╠═══════════════════════════════════════════════════════════════════════════════╣
          ║ Service: {{ service_name | default('') }}
          ║ Status: {{ '✅ Started' if start_result.status == 200 else '❌ Failed' }}
          ║ {% if start_result.status != 200 %}
          ║ Error: {{ start_result.msg }}
          ║ {% endif %}
          ║ Timestamp: {{ ansible_date_time.iso8601 }}
          ╚═══════════════════════════════════════════════════════════════════════════════╝
      when: (operation | default('list')) == 'start' and (service_name | default('')) != ''
    
    - name: Stop service
      uri:
        url: "https://{{ opnsense_host }}/api/core/service/stop"
        method: POST
        user: "{{ opnsense_api_key }}"
        password: "{{ opnsense_api_secret }}"
        force_basic_auth: yes
        validate_certs: "{{ opnsense_verify_ssl }}"
        body_format: json
        body:
          service: "{{ service_name | default('') }}"
      register: stop_result
      when: (operation | default('list')) == 'stop' and (service_name | default('')) != ''
    
    - name: Display stop result with beautiful formatting
      debug:
        msg: |
          ╔═══════════════════════════════════════════════════════════════════════════════╗
          ║                           🛑 SERVICE STOP RESULT                             ║
          ╠═══════════════════════════════════════════════════════════════════════════════╣
          ║ Service: {{ service_name | default('') }}
          ║ Status: {{ '✅ Stopped' if stop_result.status == 200 else '❌ Failed' }}
          ║ {% if stop_result.status != 200 %}
          ║ Error: {{ stop_result.msg }}
          ║ {% endif %}
          ║ Timestamp: {{ ansible_date_time.iso8601 }}
          ╚═══════════════════════════════════════════════════════════════════════════════╝
      when: (operation | default('list')) == 'stop' and (service_name | default('')) != ''
    
    - name: Restart service
      uri:
        url: "https://{{ opnsense_host }}/api/core/service/restart"
        method: POST
        user: "{{ opnsense_api_key }}"
        password: "{{ opnsense_api_secret }}"
        force_basic_auth: yes
        validate_certs: "{{ opnsense_verify_ssl }}"
        body_format: json
        body:
          service: "{{ service_name | default('') }}"
      register: restart_result
      when: (operation | default('list')) == 'restart' and (service_name | default('')) != ''
    
    - name: Display restart result with beautiful formatting
      debug:
        msg: |
          ╔═══════════════════════════════════════════════════════════════════════════════╗
          ║                         🔄 SERVICE RESTART RESULT                            ║
          ╠═══════════════════════════════════════════════════════════════════════════════╣
          ║ Service: {{ service_name | default('') }}
          ║ Status: {{ '✅ Restarted' if restart_result.status == 200 else '❌ Failed' }}
          ║ {% if restart_result.status != 200 %}
          ║ Error: {{ restart_result.msg }}
          ║ {% endif %}
          ║ Timestamp: {{ ansible_date_time.iso8601 }}
          ╚═══════════════════════════════════════════════════════════════════════════════╝
      when: (operation | default('list')) == 'restart' and (service_name | default('')) != ''

  post_tasks:
    - name: Display beautiful summary
      debug:
        msg: |
          ╔═══════════════════════════════════════════════════════════════════════════════╗
          ║                      ✅ OPNsense SERVICE MANAGEMENT COMPLETE                 ║
          ╠═══════════════════════════════════════════════════════════════════════════════╣
          ║ Operation: {{ operation | default('list') }}
          ║ {% if (service_name | default('')) != '' %}
          ║ Service: {{ service_name | default('') }}
          ║ {% endif %}
          ║ Host: {{ opnsense_host }}
          ║ Status: {{ '✅ Success' if opnsense_connectivity.status == 200 else '❌ Failed' }}
          ║ Completion Time: {{ ansible_date_time.iso8601 }}
          ╠═══════════════════════════════════════════════════════════════════════════════╣
          ║ 💡 Next Steps:                                                              ║
          ║   {% if (operation | default('list')) == 'list' %}
          ║   📋 Review service list above for status and configuration                  ║
          ║   {% else %}
          ║   🔍 Verify service status in OPNsense web interface                        ║
          ║   {% endif %}
          ╚═══════════════════════════════════════════════════════════════════════════════╝